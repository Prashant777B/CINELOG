{% extends "base.html" %}
{% block title %}{{ movie.title }} - CineLog{% endblock %}

{% block content %}
<div class="mb-4">
  <a href="{{ url_for('routes.library') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> Back to Library
  </a>
</div>

<div class="row">
  <div class="col-lg-4 mb-4">
    {% if movie.poster_path %}
      <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
           class="img-fluid rounded shadow mb-3" 
           alt="{{ movie.title }}">
    {% else %}
      <div class="bg-secondary rounded d-flex align-items-center justify-content-center mb-3" style="min-height: 600px;">
        <i class="bi bi-film" style="font-size: 5rem; opacity: 0.3;"></i>
      </div>
    {% endif %}

    <!-- Quick Actions Card -->
    <div class="card p-3">
      <h5 class="mb-3">Quick Actions</h5>
      
      <!-- Status Update -->
      <form method="post" action="{{ url_for('routes.update_status', movie_id=movie.id) }}" class="mb-3">
        <label class="form-label small">Status</label>
        <select name="status" class="form-select mb-2" onchange="this.form.submit()">
          <option value="watchlist" {% if movie.status == 'watchlist' %}selected{% endif %}>Watchlist</option>
          <option value="watching" {% if movie.status == 'watching' %}selected{% endif %}>Currently Watching</option>
          <option value="watched" {% if movie.status == 'watched' %}selected{% endif %}>Watched</option>
        </select>
      </form>

      <!-- Rating -->
      <form method="post" action="{{ url_for('routes.rate_movie', movie_id=movie.id) }}" class="mb-3">
        <label class="form-label small">Your Rating</label>
        <div class="input-group">
          <input type="number" 
                 name="rating" 
                 class="form-control" 
                 min="1" 
                 max="10" 
                 value="{{ movie.user_rating or '' }}"
                 placeholder="1-10">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-star"></i>
          </button>
        </div>
      </form>

      <hr>

      <!-- Other Actions -->
      <a href="{{ url_for('routes.review', movie_id=movie.id) }}" class="btn btn-outline-primary w-100 mb-2">
        <i class="bi bi-chat-left-text"></i> Write Review
      </a>

      <form method="post" action="{{ url_for('routes.delete_movie', movie_id=movie.id) }}" 
            onsubmit="return confirm('Are you sure you want to remove this movie from your library?');">
        <button type="submit" class="btn btn-outline-danger w-100">
          <i class="bi bi-trash"></i> Remove from Library
        </button>
      </form>
    </div>
  </div>

  <div class="col-lg-8">
    <h1 class="display-5 fw-bold mb-3">{{ movie.title }}</h1>

    <div class="row g-3 mb-4">
      {% if movie.year %}
      <div class="col-auto">
        <span class="badge bg-secondary">
          <i class="bi bi-calendar"></i> {{ movie.year }}
        </span>
      </div>
      {% endif %}

      {% if movie.runtime %}
      <div class="col-auto">
        <span class="badge bg-secondary">
          <i class="bi bi-clock"></i> {{ movie.runtime }} min
        </span>
      </div>
      {% endif %}

      <div class="col-auto">
        <span class="badge bg-{% if movie.status == 'watched' %}success{% elif movie.status == 'watching' %}info{% else %}secondary{% endif %}">
          {% if movie.status == 'watched' %}
            <i class="bi bi-check-circle"></i>
          {% elif movie.status == 'watching' %}
            <i class="bi bi-play-circle"></i>
          {% else %}
            <i class="bi bi-bookmark"></i>
          {% endif %}
          {{ movie.status }}
        </span>
      </div>

      {% if movie.user_rating %}
      <div class="col-auto">
        <span class="badge bg-warning">
          <i class="bi bi-star-fill"></i> Your Rating: {{ movie.user_rating }}/10
        </span>
      </div>
      {% elif movie.vote_average %}
      <div class="col-auto">
        <span class="badge bg-secondary">
          <i class="bi bi-star"></i> TMDB: {{ "%.1f"|format(movie.vote_average) }}/10
        </span>
      </div>
      {% endif %}
    </div>

    {% if movie.genres %}
    <div class="mb-4">
      <h5 class="mb-2">Genres</h5>
      <div class="d-flex flex-wrap gap-2">
        {% for genre in movie.genres.split(', ') %}
          <span class="badge bg-primary">{{ genre }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if movie.overview %}
    <div class="mb-4">
      <h5 class="mb-2">Overview</h5>
      <p class="text-muted">{{ movie.overview }}</p>
    </div>
    {% endif %}

    {% if movie.added_at %}
    <div class="mb-4">
      <small class="text-muted">
        <i class="bi bi-calendar-plus"></i> Added on {{ movie.added_at.strftime("%B %d, %Y") }}
      </small>
    </div>
    {% endif %}

    {% if movie.watched_at %}
    <div class="mb-4">
      <small class="text-muted">
        <i class="bi bi-check-circle"></i> Watched on {{ movie.watched_at.strftime("%B %d, %Y") }}
      </small>
    </div>
    {% endif %}

    <!-- Reviews Section -->
    <div class="card p-4 mt-4">
      <h4 class="mb-3">
        <i class="bi bi-chat-left-text"></i> Your Reviews
        <span class="badge bg-secondary">{{ reviews|length }}</span>
      </h4>

      {% if reviews %}
        <div class="list-group">
          {% for review in reviews %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                {% if review.rating %}
                  <span class="badge bg-warning me-2">
                    <i class="bi bi-star-fill"></i> {{ review.rating }}/10
                  </span>
                {% endif %}
                <small class="text-muted">
                  {{ review.created_at.strftime("%B %d, %Y at %I:%M %p") }}
                </small>
              </div>
              <form method="post" action="{{ url_for('routes.delete_review', review_id=review.id) }}"
                    onsubmit="return confirm('Are you sure you want to delete this review?');">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
            <p class="mb-0">{{ review.content }}</p>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted text-center py-4">
          <i class="bi bi-chat-left-dots" style="font-size: 2rem; opacity: 0.3;"></i><br>
          No reviews yet
        </p>
      {% endif %}

      <a href="{{ url_for('routes.review', movie_id=movie.id) }}" class="btn btn-primary mt-3">
        <i class="bi bi-plus-circle"></i> Add Review
      </a>
    </div>
  </div>
</div>

{% if movie.backdrop_path %}
<style>
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(rgba(13, 17, 23, 0.85), rgba(13, 17, 23, 0.95)), 
                url('https://image.tmdb.org/t/p/original{{ movie.backdrop_path }}');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    z-index: -1;
  }
</style>
{% endif %}
{% endblock %}
